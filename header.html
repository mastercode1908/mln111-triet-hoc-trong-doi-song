<header id="main-header"
  class="fixed top-0 left-0 right-0 z-50 w-full bg-white/95 backdrop-blur-md border-b border-gray-100 transition-shadow duration-300">
  <div class="px-4 md:px-10 py-3 max-w-7xl mx-auto flex items-center justify-between">
    <div class="flex items-center gap-8">
      <a href="home.html" class="flex items-center gap-3 text-slate-900 group cursor-pointer">
        <div class="size-8 text-primary flex items-center justify-center bg-blue-50 rounded-lg border border-blue-100">
          <span class="material-symbols-outlined">hub</span>
        </div>
        <h2 class="text-lg font-bold leading-tight tracking-tight transition-colors group-hover:text-primary font-sans">
          PhiloMap
        </h2>
      </a>
      <nav class="hidden lg:flex items-center gap-6 pl-4">
        <a id="home-link"
          class="nav-link px-3 py-2 rounded-lg hover:bg-primary/10 hover:-translate-y-px transition-all duration-300 text-slate-600 text-sm font-medium hover:text-primary relative pb-1 border-b-2 border-transparent"
          href="home.html">Trang ch·ªß</a>
        <a id="modules-link"
          class="nav-link px-3 py-2 rounded-lg hover:bg-primary/10 hover:-translate-y-px transition-all duration-300 text-slate-600 text-sm font-medium hover:text-primary relative pb-1 border-b-2 border-transparent"
          href="home.html#overview">Modules</a>

        <a class="nav-link px-3 py-2 rounded-lg hover:bg-primary/10 hover:-translate-y-px transition-all duration-300 text-slate-600 text-sm font-medium hover:text-primary relative pb-1 border-b-2 border-transparent"
          href="practice.html">Th·ª±c h√†nh</a>

        <a class="nav-link px-3 py-2 rounded-lg hover:bg-primary/10 hover:-translate-y-px transition-all duration-300 text-slate-600 text-sm font-medium hover:text-primary relative pb-1 border-b-2 border-transparent"
          href="articles.html">G√≥c nh√¨n</a>

        <a class="nav-link px-3 py-2 rounded-lg hover:bg-primary/10 hover:-translate-y-px transition-all duration-300 text-slate-600 text-sm font-medium hover:text-primary relative pb-1 border-b-2 border-transparent flex items-center gap-1"
          href="games.html">
          <span class="material-symbols-outlined text-[18px]"
            style="vertical-align: middle; line-height: 1;">sports_esports</span>
          Game
        </a>
      </nav>
    </div>
    <div class="flex items-center gap-4">
      <div class="relative group" id="search-container">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <span
            class="material-symbols-outlined text-gray-400 group-focus-within:text-primary transition-colors text-[20px]">search</span>
        </div>
        <input id="search-input"
          class="block w-64 md:w-72 pl-10 pr-4 py-2.5 bg-white border border-gray-200 rounded-full text-sm text-slate-700 placeholder-gray-400 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all shadow-sm hover:shadow-md hover:border-primary/30"
          placeholder="T√¨m ki·∫øm kh√°i ni·ªám..." type="text" autocomplete="off" />

        <!-- Search Results Dropdown -->
        <div id="search-results"
          class="hidden absolute top-full left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-96 overflow-y-auto z-50">
          <!-- Results will be populated here by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Floating AI Chat Button -->
<a id="ai-chat-btn" href="ai-assistants.html" class="fixed bottom-6 right-6 z-50 group"
  title="Tr√≤ chuy·ªán v·ªõi AI Assistants">
  <div
    class="w-14 h-14 bg-gradient-to-br from-purple-600 to-pink-600 rounded-full shadow-lg hover:shadow-2xl flex items-center justify-center transition-all duration-300 hover:scale-110 animate-pulse-slow">
    <span class="material-symbols-outlined text-white text-2xl">smart_toy</span>
  </div>
  <!-- Tooltip -->
  <div
    class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
    Tr√≤ chuy·ªán v·ªõi AI
  </div>
</a>

<!-- Floating Tet Effect Button -->
<button id="tet-toggle-btn-header" class="fixed bottom-6 right-24 z-50 group" title="Ch√∫c M·ª´ng NƒÉm M·ªõi 2026"
  onclick="window.showTetOverlay && window.showTetOverlay()">
  <div
    class="w-14 h-14 bg-gradient-to-br from-orange-400 to-red-500 rounded-full shadow-lg hover:shadow-2xl flex items-center justify-center transition-all duration-300 hover:scale-110 animate-pulse-slow">
    <span class="text-white text-2xl">üéä</span>
  </div>
  <!-- Tooltip -->
  <div
    class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
    Ch√∫c M·ª´ng NƒÉm M·ªõi 2026
  </div>
</button>

<!-- Spacer to prevent content from going under fixed header -->
<div style="height: 60px"></div>

<!-- Add CSS for smooth scroll with offset for fixed header -->
<style>
  /* Scroll offset for anchor links to account for fixed header */
  html {
    scroll-padding-top: 80px;
    /* Height of header + some padding */
    scroll-behavior: smooth;
  }

  /* Pulse scale animation for Philosophy Game button */
  @keyframes pulse-scale {

    0%,
    100% {
      transform: scale(1);
    }

    50% {
      transform: scale(1.1);
    }
  }

  .animate-pulse-scale {
    animation: pulse-scale 2s ease-in-out infinite;
  }

  /* Slow pulse animation for floating AI button */
  @keyframes pulse-slow {

    0%,
    100% {
      box-shadow:
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 0 0 0 rgba(147, 51, 234, 0.4);
    }

    50% {
      box-shadow:
        0 20px 25px -5px rgba(0, 0, 0, 0.1),
        0 0 0 10px rgba(147, 51, 234, 0);
    }
  }

  .animate-pulse-slow {
    animation: pulse-slow 2s ease-in-out infinite;
  }
</style>

<!-- Load search data inline to avoid path issues -->
<script>
  const searchData = [
    {
      title: "Module 1: Tri·∫øt h·ªçc l√† g√¨?",
      subtitle: "Kh√°i ni·ªám v√† vai tr√≤ c·ªßa tri·∫øt h·ªçc",
      url: "module1.html",
      keywords: [
        "tri·∫øt h·ªçc",
        "kh√°i ni·ªám",
        "th·∫ø gi·ªõi quan",
        "ph∆∞∆°ng ph√°p lu·∫≠n",
        "module 1",
        "m1",
      ],
      type: "module",
      icon: "school",
    },
    {
      title: "Module 2: ƒê·ªëi m·∫∑t v·ªõi thay ƒë·ªïi",
      subtitle: "Ngh·ªá thu·∫≠t ƒë·ªëi m·∫∑t v·ªõi thay ƒë·ªïi v√† √°p l·ª±c",
      url: "module2.html",
      keywords: [
        "l∆∞·ª£ng ch·∫•t",
        "m√¢u thu·∫´n",
        "ph·ªß ƒë·ªãnh",
        "bi·ªán ch·ª©ng",
        "quy lu·∫≠t",
        "module 2",
        "m2",
        "thay ƒë·ªïi",
      ],
      type: "module",
      icon: "change_circle",
    },
    {
      title: "Module 3: H√†nh tr√¨nh tri th·ª©c",
      subtitle: "Con ƒë∆∞·ªùng bi·ªán ch·ª©ng c·ªßa nh·∫≠n th·ª©c",
      url: "module3.html",
      keywords: [
        "nh·∫≠n th·ª©c",
        "th·ª±c ti·ªÖn",
        "l√Ω thuy·∫øt",
        "ch√¢n l√Ω",
        "module 3",
        "m3",
        "tri th·ª©c",
      ],
      type: "module",
      icon: "psychology",
    },
    {
      title: "Module 4: Lu·∫≠t ch∆°i x√£ h·ªôi",
      subtitle: "Ch·ªß nghƒ©a duy v·∫≠t l·ªãch s·ª≠",
      url: "module4.html",
      keywords: [
        "x√£ h·ªôi",
        "l·ªãch s·ª≠",
        "kinh t·∫ø",
        "ch√≠nh tr·ªã",
        "module 4",
        "m4",
        "duy v·∫≠t",
      ],
      type: "module",
      icon: "groups",
    },
    {
      title: "Module 5: Con ng∆∞·ªùi",
      subtitle: "M·ª•c ti√™u v√† ƒë·ªông l·ª±c",
      url: "module5.html",
      keywords: [
        "con ng∆∞·ªùi",
        "b·∫£n ch·∫•t",
        "tha h√≥a",
        "gi·∫£i ph√≥ng",
        "module 5",
        "m5",
      ],
      type: "module",
      icon: "person",
    },
    {
      title: "Th·ª±c h√†nh",
      subtitle: "B√†i t·∫≠p v√† c√¢u h·ªèi √¥n t·∫≠p",
      url: "practice.html",
      keywords: ["th·ª±c h√†nh", "b√†i t·∫≠p", "√¥n t·∫≠p", "practice"],
      type: "practice",
      icon: "edit_note",
    },
    {
      title: "Game X√¢y Th·∫ø Gi·ªõi Quan",
      subtitle: "Tr√≤ ch∆°i t∆∞∆°ng t√°c x√¢y d·ª±ng h·ªá t∆∞ duy",
      url: "worldview-game.html",
      keywords: [
        "game",
        "tr√≤ ch∆°i",
        "th·∫ø gi·ªõi quan",
        "t∆∞∆°ng t√°c",
        "x√¢y d·ª±ng",
        "worldview",
      ],
      type: "game",
      icon: "extension",
    },
    {
      title: "Tr√≤ chuy·ªán v·ªõi AI Assistants",
      subtitle: "H·ªèi ƒë√°p tri·∫øt h·ªçc d·ª±a tr√™n gi√°o tr√¨nh",
      url: "ai-assistants.html",
      keywords: [
        "ai",
        "assistant",
        "chat",
        "tr√≤ chuy·ªán",
        "gemini",
        "gi√°o tr√¨nh",
        "tri·∫øt h·ªçc m√°c - l√™nin",
      ],
      type: "page",
      icon: "smart_toy",
    },
    {
      title: "Quy lu·∫≠t L∆∞·ª£ng - Ch·∫•t",
      subtitle: "Module 2",
      url: "module2.html",
      keywords: ["l∆∞·ª£ng", "ch·∫•t", "ƒë·ªô", "ƒëi·ªÉm n√∫t", "b∆∞·ªõc nh·∫£y"],
      type: "concept",
      icon: "science",
    },
    {
      title: "Quy lu·∫≠t M√¢u thu·∫´n",
      subtitle: "Module 2",
      url: "module2.html",
      keywords: ["m√¢u thu·∫´n", "ƒë·ªëi l·∫≠p", "ƒë·∫•u tranh"],
      type: "concept",
      icon: "balance",
    },
    {
      title: "Trang ch·ªß",
      subtitle: "T·ªïng quan v·ªÅ PhiloMap",
      url: "home.html",
      keywords: ["trang ch·ªß", "home", "overview"],
      type: "page",
      icon: "home",
    },
  ];
  console.log("‚úì Search data loaded:", searchData.length, "items");
</script>

<script>
  // Add shadow to header on scroll
  window.addEventListener("scroll", function () {
    const header = document.getElementById("main-header");
    if (header && window.scrollY > 10) {
      header.classList.add("shadow-md");
    } else if (header) {
      header.classList.remove("shadow-md");
    }
  });

  // Search functionality
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("search-input");
    const searchResults = document.getElementById("search-results");
    const searchContainer = document.getElementById("search-container");
    let selectedIndex = -1;

    if (!searchInput || !searchResults) {
      console.error("Search elements not found");
      return;
    }

    // Check if searchData is loaded
    if (typeof searchData === "undefined") {
      console.error(
        "searchData is not loaded. Make sure search-data.js is loaded correctly.",
      );
      return;
    }

    console.log("Search initialized with", searchData.length, "items");

    // Search function
    function performSearch(query) {
      if (!query || query.trim().length < 2) {
        searchResults.classList.add("hidden");
        return;
      }

      query = query.toLowerCase().trim();

      // Filter search data
      const results = searchData
        .filter((item) => {
          return (
            item.title.toLowerCase().includes(query) ||
            item.subtitle.toLowerCase().includes(query) ||
            item.keywords.some((keyword) =>
              keyword.toLowerCase().includes(query),
            )
          );
        })
        .slice(0, 8); // Limit to 8 results

      console.log("Search query:", query, "Results:", results.length);
      displayResults(results, query);
    }

    // Display results
    function displayResults(results, query) {
      console.log("displayResults called with", results.length, "results");
      console.log("searchResults element:", searchResults);

      if (results.length === 0) {
        searchResults.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <span class="material-symbols-outlined text-3xl mb-2 opacity-50">search_off</span>
                        <p class="text-sm">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho "${query}"</p>
                    </div>
                `;
        searchResults.classList.remove("hidden");
        console.log("Showing empty state, classes:", searchResults.className);
        return;
      }

      const html = results
        .map(
          (item, index) => `
                <a href="${item.url}" 
                   class="search-result-item flex items-start gap-3 p-3 hover:bg-blue-50 transition-colors cursor-pointer border-b border-gray-100 last:border-b-0"
                   data-index="${index}">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined text-[20px]">${item.icon}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-sm text-gray-900 truncate">${highlightText(item.title, query)}</div>
                        <div class="text-xs text-gray-500 truncate">${item.subtitle}</div>
                        <div class="text-xs text-primary mt-0.5 capitalize">${getTypeLabel(item.type)}</div>
                    </div>
                </a>
            `,
        )
        .join("");

      searchResults.innerHTML = html;
      searchResults.classList.remove("hidden");
      console.log("Showing results, classes:", searchResults.className);
      selectedIndex = -1;
    }

    // Highlight matching text
    function highlightText(text, query) {
      const regex = new RegExp(`(${escapeRegex(query)})`, "gi");
      return text.replace(
        regex,
        '<mark class="bg-yellow-200 text-gray-900">$1</mark>',
      );
    }

    // Escape special regex characters
    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    // Get type label in Vietnamese
    function getTypeLabel(type) {
      const labels = {
        module: "Module",
        concept: "Kh√°i ni·ªám",
        practice: "Th·ª±c h√†nh",
        game: "Tr√≤ ch∆°i",
        page: "Trang",
      };
      return labels[type] || type;
    }

    // Event listeners
    searchInput.addEventListener("input", function (e) {
      performSearch(e.target.value);
    });

    searchInput.addEventListener("focus", function (e) {
      if (e.target.value.trim().length >= 2) {
        performSearch(e.target.value);
      }
    });

    // Keyboard navigation
    searchInput.addEventListener("keydown", function (e) {
      const items = searchResults.querySelectorAll(".search-result-item");

      if (e.key === "ArrowDown") {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelection(items);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection(items);
      } else if (e.key === "Enter" && selectedIndex >= 0) {
        e.preventDefault();
        items[selectedIndex].click();
      } else if (e.key === "Escape") {
        searchResults.classList.add("hidden");
        searchInput.blur();
      }
    });

    // Update selection highlight
    function updateSelection(items) {
      items.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add("bg-blue-50");
          item.scrollIntoView({ block: "nearest" });
        } else {
          item.classList.remove("bg-blue-50");
        }
      });
    }

    // Click outside to close
    document.addEventListener("click", function (e) {
      if (searchContainer && !searchContainer.contains(e.target)) {
        searchResults.classList.add("hidden");
      }
    });

    // Prevent dropdown from closing when clicking inside
    searchResults.addEventListener("click", function (e) {
      e.stopPropagation();
    });
  });

  // Smart navigation for Modules link
  document.addEventListener("DOMContentLoaded", function () {
    const modulesLink = document.getElementById("modules-link");
    if (modulesLink) {
      modulesLink.addEventListener("click", function (e) {
        const currentPage =
          window.location.pathname.split("/").pop() || "home.html";

        // If we're already on home.html, just scroll to overview
        if (currentPage === "home.html" || currentPage === "") {
          e.preventDefault();
          const overviewSection = document.getElementById("overview");
          if (overviewSection) {
            overviewSection.scrollIntoView({ behavior: "smooth" });
          }
        }
        // Otherwise, let the link navigate to home.html#overview normally
      });
    }

    // Update active nav link based on scroll position (only on home page)
    const currentPage =
      window.location.pathname.split("/").pop() || "home.html";
    if (currentPage === "home.html" || currentPage === "") {
      function updateNavOnScroll() {
        const overviewSection = document.getElementById("overview");
        if (!overviewSection) return;

        const overviewTop = overviewSection.getBoundingClientRect().top;
        const threshold = 200; // Pixels from top to consider "in overview"

        const homeLink = document.querySelector('a[href="home.html"]');
        const modulesLinkNav = document.getElementById("modules-link");

        if (overviewTop <= threshold) {
          // We're in overview section - highlight Modules
          if (homeLink) {
            homeLink.className =
              "nav-link px-3 py-2 rounded-lg hover:bg-primary/10 hover:-translate-y-px transition-all duration-300 text-slate-600 text-sm font-medium hover:text-primary relative pb-1 border-b-2 border-transparent";
          }
          if (modulesLinkNav) {
            modulesLinkNav.className =
              "nav-link px-3 py-2 rounded-lg hover:bg-primary/10 hover:-translate-y-px transition-all duration-300 text-primary text-sm font-bold hover:text-primary relative pb-1 border-b-2 border-primary";
          }
        } else {
          // We're in hero section - highlight Trang ch·ªß
          if (homeLink) {
            homeLink.className =
              "nav-link px-3 py-2 rounded-lg hover:bg-primary/10 hover:-translate-y-px transition-all duration-300 text-primary text-sm font-bold hover:text-primary relative pb-1 border-b-2 border-primary";
          }
          if (modulesLinkNav) {
            modulesLinkNav.className =
              "nav-link px-3 py-2 rounded-lg hover:bg-primary/10 hover:-translate-y-px transition-all duration-300 text-slate-600 text-sm font-medium hover:text-primary relative pb-1 border-b-2 border-transparent";
          }
        }
      }

      // Listen to scroll events
      window.addEventListener("scroll", updateNavOnScroll);
      // Run once on load
      setTimeout(updateNavOnScroll, 100);
    }
  });
</script>